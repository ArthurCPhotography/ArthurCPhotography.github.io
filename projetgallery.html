<script>
/* ======= UTILITAIRES ======= */

// crée/supprime overlay sur un wrapper (pour miniatures)
function ensureGalleryOverlay(wrapper) {
  // si overlay déjà présent, on ne crée pas de doublon
  let overlay = wrapper.querySelector('.__img-protect-overlay');
  const link = wrapper.querySelector('a');
  if (!link) return;

  const img = wrapper.querySelector('img');
  if (!img) return;

  // protection clic droit / drag sur l'image
  img.addEventListener('contextmenu', e => e.preventDefault());
  img.addEventListener('dragstart', e => e.preventDefault());

  if (!overlay) {
    overlay = document.createElement('div');
    overlay.className = '__img-protect-overlay';
    overlay.style.position = 'absolute';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.zIndex = '10';
    overlay.style.background = 'transparent';
    overlay.style.cursor = 'pointer'; // visuellement identique

    // click normal -> déclenche le lien (ouvre Fancybox)
    overlay.addEventListener('click', (ev) => {
      // forward click to anchor, letting Fancybox open
      link.click();
    });

    // detect long press on mobile and block it
    let pressTimer = null;
    const start = (ev) => {
      // start timer to detect long press
      // we don't call ev.preventDefault() here (would block tap)
      pressTimer = setTimeout(() => {
        // if timer fires, prevent default behaviour (try to block menu)
        // note: preventDefault on this touch event may work in many browsers but not all
        ev.preventDefault && ev.preventDefault();
      }, 600); // 600ms = threshold for long press
    };
    const cancel = () => {
      if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; }
    };

    overlay.addEventListener('touchstart', start, { passive: false });
    overlay.addEventListener('touchend', cancel);
    overlay.addEventListener('touchmove', cancel);
    overlay.addEventListener('contextmenu', e => e.preventDefault());

    // make sure wrapper positioned
    const prevPos = getComputedStyle(wrapper).position;
    if (prevPos === 'static') wrapper.style.position = 'relative';

    wrapper.appendChild(overlay);
  }
}

// remove any existing overlays created by previous attempts (cleanup)
function cleanupGalleryOverlays() {
  document.querySelectorAll('.__img-protect-overlay').forEach(el => el.remove());
}

/* ======= PROTECTION GALERIE ======= */
function protectGallery() {
  cleanupGalleryOverlays();
  document.querySelectorAll('.gallery .img-wrapper').forEach(wrapper => {
    ensureGalleryOverlay(wrapper);
  });
}

/* ======= PROTECTION FANCYBOX (toutes les slides) ======= */
function protectFancyboxInstance(fancybox) {
  // applique protection à la slide actuelle
  const applyToCurrent = () => {
    // supprime overlays précédents éventuels dans le container fancybox
    const container = fancybox?.$container;
    if (!container) return;

    // remove older overlays we created inside fancybox
    container.querySelectorAll('.__fancybox-protect-overlay').forEach(o => o.remove());

    // chercher l'image (sélecteur général)
    const img = container.querySelector('img');
    if (!img) return;

    // bloquer clic droit et drag sur l'image
    img.addEventListener('contextmenu', e => e.preventDefault());
    img.addEventListener('dragstart', e => e.preventDefault());

    // ajouter overlay (sur le parent de l'image) pour intercepter longpress sur mobile
    const parent = img.parentNode;
    if (!parent) return;

    // créer overlay
    const overlay = document.createElement('div');
    overlay.className = '__fancybox-protect-overlay';
    overlay.style.position = 'absolute';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.zIndex = '20';
    overlay.style.background = 'transparent';
    // Don't forward click: Fancybox handles clicks/gestures; overlay will only intercept long press / contextmenu
    overlay.addEventListener('contextmenu', e => e.preventDefault());

    // long press detection (dissuade save on mobile)
    let pressTimer = null;
    const start = (ev) => {
      pressTimer = setTimeout(() => {
        // try to prevent the native menu
        ev.preventDefault && ev.preventDefault();
      }, 600);
    };
    const cancel = () => {
      if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; }
    };
    overlay.addEventListener('touchstart', start, { passive: false });
    overlay.addEventListener('touchend', cancel);
    overlay.addEventListener('touchmove', cancel);

    // ensure parent positioned
    const prevPos = getComputedStyle(parent).position;
    if (prevPos === 'static') parent.style.position = 'relative';

    parent.appendChild(overlay);
  };

  // apply for first shown slide
  applyToCurrent();

  // apply on each slide change
  try {
    fancybox.Carousel && fancybox.Carousel.on && fancybox.Carousel.on('change', applyToCurrent);
  } catch (err) {
    // fallback: try to re-apply on 'done' event (older versions)
    fancybox.on && fancybox.on('done', applyToCurrent);
  }
}

/* ======= INITIALISATION ======= */

// protect gallery overlays now
protectGallery();

// also observe DOM for added/removed gallery items (in case you dynamically change them)
const galleryNode = document.querySelector('.gallery');
if (galleryNode) {
  const obs = new MutationObserver(() => {
    // re-create overlays for any new items
    protectGallery();
  });
  obs.observe(galleryNode, { childList: true, subtree: true });
}

/* ======= FANCYBOX BIND & PROTECT ======= */
Fancybox.bind("[data-fancybox='gallery-animaux']", {
  Toolbar: { display: ["close"] },
  Thumbs: false,
  dragToClose: true,
  animated: true,
  caption: (fancybox, carousel, slide) => slide.caption,
  hideScrollbar: false,
  // ready fires when Fancybox instance is ready
  on: {
    ready: (fancybox) => {
      try {
        protectFancyboxInstance(fancybox);
      } catch (err) {
        // silent
        console.error('protectFancyboxInstance error', err);
      }
    },
    // also ensure protection when Fancybox is opened via other ways
    done: (fancybox) => {
      try { protectFancyboxInstance(fancybox); } catch(e){}
    }
  }
});
</script>
